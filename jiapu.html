<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>桐梓杨氏景伯祖世系信息图</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f8f9fa;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        .flowchart-node {
            border: 2px solid #00A6ED;
            color: #242325;
            background-color: #ffffff;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .flowchart-line {
            background-color: #7FB800;
            position: absolute;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -29px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background-color: #FFB400;
            border: 4px solid #f8f9fa;
        }
        .chat-message {
            margin-bottom: 0.5rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            word-wrap: break-word; /* Ensure long words break */
        }
        .chat-message.user {
            background-color: #e0f2fe; /* Light blue for user */
            align-self: flex-end;
            text-align: right;
            margin-left: auto;
        }
        .chat-message.ai {
            background-color: #f0f4f8; /* Light gray for AI */
            align-self: flex-start;
            text-align: left;
            margin-right: auto;
        }
        .chat-history-display {
            height: 300px; /* Fixed height for chat history */
            overflow-y: auto; /* Enable scrolling */
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
    </style>
</head>
<body class="text-[#242325]">

    <!-- 
    Infographic Narrative Plan:
    1.  Introduction: Hook with the title and the grand scope of the genealogy.
    2.  New Feature: Family Genealogy Chatbot (LLM-powered conversational search) - MOVED TO FRONT.
    3.  The Progenitor's Journey: Detail the historical migration of Jingbo Zu due to the Yang Yinglong Incident using a timeline.
    4.  Family Structure: Visualize the main four branches of the family using an HTML/CSS flowchart.
    5.  Generational Legacy: Display the unique 17-character generation naming system.
    6.  Clan Demographics: Use charts to show population by generation, geographical distribution, and the prevalence of the name "Qiang".
    7.  Modern Heritage: Highlight the 2012 recompilation effort and the role of key members like Yang Qiang.
    8.  Conclusion: Summarize the clan's resilience and enduring legacy.
    
    Color Palette Selection: "Energetic & Playful" (#00A6ED, #7FB800, #FFB400, #F6511D, #242325). Chosen for its vibrant, high-contrast nature to make historical data engaging and modern.

    Visualization Choices (NO SVG, NO Mermaid JS):
    -   Progenitor's Migration: HTML/CSS Timeline. Goal: Show Change. Justification: Clearly represents sequential events over time.
    -   Family Branching: HTML/CSS Flowchart. Goal: Organize. Justification: Effectively shows hierarchical structure without using prohibited technologies like SVG or Mermaid.
    -   Generation Population: Chart.js Bar Chart. Goal: Compare. Justification: Ideal for comparing quantities across discrete categories (generations).
    -   Geographic Distribution: Chart.js Donut Chart. Goal: Compare (Composition). Justification: Excellent for showing parts of a whole for a few key locations.
    -   "Qiang" Name Analysis: Chart.js Bar Chart. Goal: Compare. Justification: Best for comparing the frequency of a name across different generation categories.
    -   Key Stats (e.g., compilation year): Large Text/Number. Goal: Inform. Justification: High impact for a single, important data point.
    -   Family Genealogy Chatbot (LLM): Text output from Gemini API. Goal: Inform/Engage. Justification: Provides personalized, context-aware answers to specific queries.
    
    Confirmation: NEITHER Mermaid JS NOR SVG were used anywhere in this output. All diagrams are built with HTML/CSS and all charts are rendered on Canvas by Chart.js.
    -->

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-6xl font-bold text-[#00A6ED] mb-4">桐梓杨氏景伯祖世系</h1>
            <p class="text-lg md:text-xl text-gray-600 max-w-3xl mx-auto">一份跨越数百年历史的家族史诗，记录了杨氏家族从播州之乱到现代繁荣的迁徙、传承与复兴。</p>
        </header>

        <main class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">

            <section class="lg:col-span-3 bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold text-[#FFB400] mb-4">家族谱系问答 ✨</h2>
                <p class="text-gray-700 mb-4">您可以提问关于家族成员的信息，例如：“请告诉我杨强是哪一年出生的？”或“杨强的家庭成员有哪些？”</p>
                <div id="chatHistoryDisplay" class="chat-history-display mb-4">
                    <div class="chat-message ai">你好！我是您的家族谱系助手。请问您有什么关于桐梓杨氏景伯祖世系的问题吗？</div>
                </div>
                <div class="flex flex-col md:flex-row gap-4">
                    <input type="text" id="chatInput" placeholder="输入您的问题..." class="flex-grow p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#FFB400]">
                    <button id="sendChatBtn" class="bg-[#FFB400] text-white font-bold py-3 px-6 rounded-md shadow-md hover:bg-orange-500 transition duration-300 ease-in-out">
                        发送
                    </button>
                </div>
            </section>

            <section class="lg:col-span-3 bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold text-[#F6511D] mb-4">始祖的足迹：景伯祖的迁徙史</h2>
                <p class="text-gray-700 mb-6">家族的根源可追溯至明朝万历年间。因“杨应龙事件”，播州杨氏遭遇灭顶之灾。始祖景伯祖幸免于难，为避祸开始了艰难的迁徙，最终在桐梓农会场落地生根，为家族的延续奠定了基础。</p>
                <div class="relative pl-8 border-l-4 border-gray-200">
                    <div class="timeline-item mb-8">
                        <h3 class="font-semibold text-lg">约 1600年</h3>
                        <p class="text-gray-600">“杨应龙事件”爆发，播州杨氏统治瓦解，家族成员四处逃亡。</p>
                    </div>
                    <div class="timeline-item mb-8">
                        <h3 class="font-semibold text-lg">迁徙初期</h3>
                        <p class="text-gray-600">景伯祖从遵义出发，经绥阳，避祸至正安。</p>
                    </div>
                    <div class="timeline-item">
                        <h3 class="font-semibold text-lg">最终定居</h3>
                        <p class="text-gray-600">景伯祖再次迁徙，最终定居于桐梓农会场，开枝散叶，子孙繁衍至今。</p>
                    </div>
                </div>
            </section>

            <section class="lg:col-span-3 bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold text-[#7FB800] mb-6 text-center">家族的根基：四大支系繁衍图</h2>
                <p class="text-gray-700 mb-8 text-center max-w-2xl mx-auto">景伯祖之子在朝祖育有四子，他们构成了桐梓杨氏最主要的四大支系，后代遍布各地，形成了紧密的家族网络。</p>
                <div class="relative flex flex-col items-center py-4">
                    <div class="flowchart-node mb-8">景伯祖 (入桐始祖)</div>
                    <div class="flowchart-line" style="width: 2px; height: 32px; top: 68px; left: 50%; transform: translateX(-50%);"></div>
                    <div class="flowchart-node absolute" style="top: 100px;">在朝祖</div>
                    <div class="flowchart-line" style="width: 2px; height: 32px; top: 156px; left: 50%; transform: translateX(-50%);"></div>
                    <div class="flowchart-line hidden md:block" style="width: 75%; height: 2px; top: 188px; left: 12.5%;"></div>
                    
                    <div class="w-full mt-28 grid grid-cols-1 md:grid-cols-4 gap-y-12 md:gap-y-0 md:gap-x-4 text-center">
                        <div class="relative flex justify-center">
                            <div class="flowchart-line absolute" style="width: 2px; height: 32px; top: -32px; left: 50%; transform: translateX(-50%);"></div>
                            <div class="flowchart-node">惟栋祖 (长房)</div>
                        </div>
                        <div class="relative flex justify-center">
                             <div class="flowchart-line absolute hidden md:block" style="width: 2px; height: 32px; top: -32px; left: 50%; transform: translateX(-50%);"></div>
                            <div class="flowchart-node">惟选祖 (二房)</div>
                        </div>
                        <div class="relative flex justify-center">
                             <div class="flowchart-line absolute hidden md:block" style="width: 2px; height: 32px; top: -32px; left: 50%; transform: translateX(-50%);"></div>
                            <div class="flowchart-node">惟材祖 (三房)</div>
                        </div>
                        <div class="relative flex justify-center">
                             <div class="flowchart-line absolute hidden md:block" style="width: 2px; height: 32px; top: -32px; left: 50%; transform: translateX(-50%);"></div>
                            <div class="flowchart-node">惟樑祖 (四房)</div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="md:col-span-2 lg:col-span-1 bg-white rounded-lg shadow-md p-6 flex flex-col">
                <h2 class="text-2xl font-bold text-[#00A6ED] mb-4">世代的烙印：辈分排行</h2>
                <p class="text-gray-700 mb-4 flex-grow">家族采用严格的17字辈分排行，确保宗族秩序，维系血脉联系。这一体系是家族身份认同的核心。</p>
                <div class="grid grid-cols-4 gap-2 text-center">
                    <span class="p-2 bg-blue-100 text-blue-800 rounded">景</span>
                    <span class="p-2 bg-blue-100 text-blue-800 rounded">在</span>
                    <span class="p-2 bg-blue-100 text-blue-800 rounded">惟</span>
                    <span class="p-2 bg-blue-100 text-blue-800 rounded">茂</span>
                    <span class="p-2 bg-blue-100 text-blue-800 rounded">学</span>
                    <span class="p-2 bg-blue-100 text-blue-800 rounded">单名</span>
                    <span class="p-2 bg-blue-100 text-blue-800 rounded">文</span>
                    <span class="p-2 bg-blue-100 text-blue-800 rounded">正</span>
                    <span class="p-2 bg-blue-100 text-blue-800 rounded">大</span>
                    <span class="p-2 bg-blue-100 text-blue-800 rounded">光</span>
                    <span class="p-2 bg-blue-100 text-blue-800 rounded">明</span>
                    <span class="p-2 bg-blue-100 text-blue-800 rounded">世</span>
                    <span class="p-2 bg-orange-100 text-orange-800 rounded font-bold">代</span>
                    <span class="p-2 bg-orange-100 text-orange-800 rounded font-bold">朝</span>
                    <span class="p-2 bg-orange-100 text-orange-800 rounded font-bold">忠</span>
                    <span class="p-2 bg-orange-100 text-orange-800 rounded font-bold">家</span>
                    <span class="p-2 bg-orange-100 text-orange-800 rounded font-bold">国</span>
                </div>
            </section>

            <section class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold text-[#FFB400] mb-4">家族人口分布 (按辈分)</h2>
                <p class="text-gray-700 mb-4">从家谱记录来看，近几代人丁兴旺，“代”、“朝”、“忠”三辈是家族的中坚力量，而“家”、“国”辈则代表着家族的未来与希望。</p>
                <div class="chart-container h-80 md:h-96">
                    <canvas id="generationChart"></canvas>
                </div>
            </section>

            <section class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold text-[#F6511D] mb-4">主要聚居地分布</h2>
                <p class="text-gray-700 mb-4">家族后裔主要分布在桐梓县内的几个关键地区，其中田沟、杨家沟、底水坝和水井窝是人口最集中的四大聚居地。</p>
                <div class="chart-container h-80 md:h-96">
                    <canvas id="locationChart"></canvas>
                </div>
            </section>

            <section class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold text-[#7FB800] mb-4">名字中的“强”字分析</h2>
                <p class="text-gray-700 mb-4">“强”字并非辈分排行字，但在族人名字中频繁出现，尤其在“忠”字辈中最为普遍，寄托了长辈对后代强健、强大的美好祝愿。</p>
                <div class="chart-container h-80 md:h-96">
                    <canvas id="nameChart"></canvas>
                </div>
            </section>

            <section class="md:col-span-2 lg:col-span-3 bg-white rounded-lg shadow-md p-6 flex flex-col md:flex-row items-center gap-8">
                <div class="text-center md:text-left">
                    <h2 class="text-2xl font-bold text-[#00A6ED] mb-4">现代传承：2012版家谱编撰</h2>
                    <p class="text-gray-700 mb-4">为延续家族记忆，族人于2011年倡议重修家谱。在杨朝纯、杨朝贵等人的推动下，新版家谱于2012年9月完成。其中，“忠”字辈的杨强先生担任了关键的排版编辑工作，为这份宝贵的家族文献付出了心血。</p>
                    <p class="text-gray-700">他的参与，是年轻一代继承和发扬家族文化的生动体现。</p>
                </div>
                <div class="flex-shrink-0 text-center bg-blue-50 p-8 rounded-lg">
                    <div class="text-7xl font-bold text-[#00A6ED]">2012</div>
                    <div class="text-xl font-semibold text-gray-700 mt-2">新版家谱完成年份</div>
                </div>
            </section>

        </main>

        <footer class="text-center mt-12 text-gray-500">
            <p>数据来源：《桐梓杨氏景伯祖世系家谱》(2012年版)</p>
            <p>信息图生成于 &copy; 2024</p>
        </footer>

    </div>

    <script>
        function wrapLabels(label, maxWidth) {
            const words = label.split(' ');
            let lines = [];
            let currentLine = '';
            for (const word of words) {
                if ((currentLine + word).length > maxWidth) {
                    lines.push(currentLine.trim());
                    currentLine = '';
                }
                currentLine += word + ' ';
            }
            lines.push(currentLine.trim());
            return lines.filter(line => line.length > 0);
        }

        const tooltipTitleCallback = (tooltipItems) => {
            const item = tooltipItems[0];
            let label = item.chart.data.labels[item.dataIndex];
            if (Array.isArray(label)) {
                return label.join(' ');
            }
            return label;
        };

        const defaultChartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        title: tooltipTitleCallback
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#242325'
                    },
                    grid: {
                        color: '#e5e7eb'
                    }
                },
                x: {
                    ticks: {
                        color: '#242325'
                    },
                    grid: {
                        display: false
                    }
                }
            }
        };

        const chartColors = ['#00A6ED', '#7FB800', '#FFB400', '#F6511D'];

        new Chart(document.getElementById('generationChart'), {
            type: 'bar',
            data: {
                labels: ['代', '朝', '忠', '家', '国'],
                datasets: [{
                    label: '记录人数',
                    data: [10, 12, 15, 8, 2],
                    backgroundColor: chartColors,
                    borderColor: chartColors,
                    borderWidth: 1
                }]
            },
            options: { ...defaultChartOptions }
        });

        new Chart(document.getElementById('locationChart'), {
            type: 'doughnut',
            data: {
                labels: ['田沟', '杨家沟', '底水坝', '水井窝', '其他'],
                datasets: [{
                    label: '聚居地',
                    data: [35, 25, 20, 15, 5],
                    backgroundColor: [
                        '#00A6ED',
                        '#7FB800',
                        '#FFB400',
                        '#F6511D',
                        '#cccccc'
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    tooltip: {
                        callbacks: {
                           title: tooltipTitleCallback
                        }
                    }
                }
            }
        });

        new Chart(document.getElementById('nameChart'), {
            type: 'bar',
            data: {
                labels: ['代字辈', '朝字辈', '忠字辈', '家字辈'],
                datasets: [{
                    label: '名为“强”的人数',
                    data: [2, 1, 5, 2],
                    backgroundColor: chartColors.slice(0, 4),
                    borderColor: chartColors.slice(0, 4),
                    borderWidth: 1
                }]
            },
            options: { ...defaultChartOptions }
        });

        // Gemini API Integration for Chatbot
        const chatHistoryDisplay = document.getElementById('chatHistoryDisplay');
        const chatInput = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');

        let chatHistory = []; // Stores conversation history for LLM context

        const familyData = `
            以下是桐梓杨氏景伯祖世系家谱中关于家族成员的详细信息：

            **杨强 (忠字辈，家谱排版编辑)**:
            - 出生日期: 农历1977年9月3日
            - 婚姻状况: 未婚
            - 教育背景: 原贵州工学院毕业
            - 居住地: 深圳
            - 父亲: 杨朝棣 (杨代金次子, 1942年4月10日生, 居底水坝)
            - 母亲: 苏慎芬 (1943年9月3日生, 原籍茅石乡茅坪)
            - 兄弟姐妹:
                - 长兄: 杨忠健 (1974年1月2日生, 居桐梓城区, 配偶胡定美(1978年7月8日生), 育两子钧昊和家诚)
                - 姐姐: 忠敏 (1970年出生, 配偶胡玉国, 居遵义市区)
                - 姐姐: 忠莉 (1972年出生, 配偶张宗志, 居桐梓651厂旁)
                - 妹妹: 小红 (1981年7月13日生, 配偶赵小川(重庆江津人), 居遵义市区)
            - 家谱角色: 排版编辑，电子邮箱yqse@163.com

            **其他名字中含“强”字的家族成员**:
            - **杨家强 (杨强娃)**: 辈分“家”, 父亲杨忠友, 1982年11月7日生, 居桐梓城区, 配偶李梅, 女慕燃(2012年3月30日生)。
            - **杨忠强 (杨朝烈之子)**: 辈分“忠”, 父亲杨朝烈, 1931年出生, 居田沟, 配偶周国梅, 子家鑫, 女家容、家敏。
            - **杨家强 (杨忠元之子)**: 辈分“家”, 父亲杨忠元, 1966年出生, 居田沟。
            - **杨忠强 (杨朝俊之子)**: 辈分“忠”, 父亲杨朝俊, 1941年出生, 居田沟, 配偶周大英, 子家权, 女家群。
            - **杨忠强 (杨朝学之子)**: 辈分“忠”, 父亲杨朝学, 1954年10月4日生, 居板桥中寺谭家塆, 配偶黄氏, 子家奥, 女家利。
            - **杨朝强 (杨代友之子)**: 辈分“朝”, 父亲杨代友, 1958年2月生, 居水井窝, 配偶令狐绍英, 女忠怡。
            - **杨忠强 (杨朝佑之子)**: 辈分“忠”, 父亲杨朝佑, 1955年出生, 居杨家沟, 配偶吴远平, 女家倩、博雯。
            - **杨代强 (杨世贵之子)**: 辈分“代”, 父亲杨世贵, 1932年出生, 居杨家沟, 配偶李应秋, 子朝鑫。
            - **杨代强 (杨世义之子)**: 辈分“代”, 父亲杨世义, 1979年3月20日生, 居桐梓鱼溪沟。
            - **杨永启 (朝字辈)**: 父亲杨代芳, 1974年3月14日生, 配偶贺萍, 三子杨林、杨钦、杨鑫, 两女杨丹、杨焰。
            - **杨鑫 (忠字辈)**: 父亲杨永启, 2008年12月19日生。
            - **杨永财 (朝字辈)**: 父亲杨代芳, 1984年5月29日生, 配偶伍玲玲, 两女杨婷婷、杨微微。

            辈分排行: 景、在、惟、茂、学、(单名)、文、正、大、光、明、世、代、朝、忠、家、国。
            请注意，家谱中可能存在同名情况，请根据辈分、父母等信息进行区分。
        `;

        function addMessageToChat(message, sender) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('chat-message', sender);
            messageElement.textContent = message;
            chatHistoryDisplay.appendChild(messageElement);
            chatHistoryDisplay.scrollTop = chatHistoryDisplay.scrollHeight; // Scroll to bottom
        }

        sendChatBtn.addEventListener('click', async () => {
            const userQuery = chatInput.value.trim();
            if (!userQuery) return;

            addMessageToChat(userQuery, 'user');
            chatInput.value = ''; // Clear input

            // Add user query to chat history for LLM context
            chatHistory.push({ role: "user", parts: [{ text: userQuery }] });

            sendChatBtn.disabled = true;
            const originalButtonText = sendChatBtn.textContent;
            sendChatBtn.textContent = '思考中...';

            try {
                // Construct the prompt with system instruction, family data, and conversation history
                const systemInstruction = `你是一个家族谱系专家，你的任务是根据提供的家族信息，回答用户关于家族成员的提问。请只回答基于你所提供的信息，不要编造。如果信息不在你提供的内容中，请说明你无法找到相关信息。请以简洁、直接的中文回答。`;
                
                // For the first message, include the system instruction and family data.
                // For subsequent messages, the chatHistory already contains this context.
                let contentsToSend = chatHistory;
                if (chatHistory.length === 1) { // If this is the very first user message
                    contentsToSend = [{ role: "user", parts: [{ text: systemInstruction + "\n\n" + familyData + "\n\n" + userQuery }] }];
                } else {
                    // For subsequent messages, prepend the system instruction and family data to the current turn's user message
                    // This ensures the model always has the full context for each turn, even if chatHistory grows long.
                    // A more robust solution for very long histories would involve summarization.
                    contentsToSend = [
                        { role: "user", parts: [{ text: systemInstruction + "\n\n" + familyData }] },
                        ...chatHistory
                    ];
                }

                const payload = { contents: contentsToSend };
                
                // 请将 YOUR_API_KEY_HERE 替换为您的实际 Gemini API 密钥
                const apiKey = "AIzaSyDoDWUH-TBds1CXbFqQIT5O7p9RvCWXzo0"; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                console.log('Sending API request with payload:', payload);
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                console.log('API response received. Status:', response.status);

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error('API request failed:', response.status, response.statusText, errorBody);
                    const errorMessage = `API请求失败 (${response.status} ${response.statusText})。这可能是由于API配额或速率限制，或网络问题。请稍后重试。`;
                    addMessageToChat(errorMessage, 'ai');
                    chatHistory.push({ role: "model", parts: [{ text: errorMessage }] }); // Add error to history
                    return;
                }

                const result = await response.json();
                console.log('API response JSON:', result);
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const aiResponse = result.candidates[0].content.parts[0].text;
                    addMessageToChat(aiResponse, 'ai');
                    chatHistory.push({ role: "model", parts: [{ text: aiResponse }] }); // Add AI response to history
                    console.log('AI response generated successfully:', aiResponse);
                } else {
                    console.warn('API returned empty or malformed candidates:', result);
                    const errorMessage = '未能从家谱信息中找到相关内容，请尝试换个问题。';
                    addMessageToChat(errorMessage, 'ai');
                    chatHistory.push({ role: "model", parts: [{ text: errorMessage }] }); // Add error to history
                }
            } catch (error) {
                console.error('Error during API call or processing:', error);
                const errorMessage = '生成回答时发生网络或处理错误，请检查控制台。';
                addMessageToChat(errorMessage, 'ai');
                chatHistory.push({ role: "model", parts: [{ text: errorMessage }] }); // Add error to history
            } finally {
                sendChatBtn.disabled = false;
                sendChatBtn.textContent = originalButtonText;
            }
        });

        // Allow sending message with Enter key
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !sendChatBtn.disabled) {
                sendChatBtn.click();
            }
        });
    </script>
</body>
</html>
